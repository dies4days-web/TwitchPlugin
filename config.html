<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Twitch Video Component - Config</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {font-family: Arial, sans-serif; background:#18181b; color:#efeff1; padding:20px;}
    input {width:100%; padding:10px; margin:10px 0; background:#1f1f23; border:1px solid #9146ff; color:#fff;}
    button {background:#9146ff; color:#fff; border:none; padding:10px 20px; cursor:pointer; margin:5px;}
    button:hover {background:#7c3aed;}
    .friend {display:flex; align-items:center; background:#1f1f23; padding:10px; margin:10px 0;}
    .friend img {border-radius:50%; width:48px; height:48px; margin-right:10px;}
    .friend span {flex:1;}
  </style>
</head>
<body>
  <h1>Friends List Config</h1>
  <input type="text" id="username" placeholder="Twitch username (exact login name)" />
  <button id="add">Add Friend</button>
  <div id="list"></div>
  <button id="save">Save & Close</button>

  <script>
    const clientId = 'v52hn2spd1ldo2zo34iv91xtkoo98s';
    const listEl = document.getElementById('list');
    const addBtn = document.getElementById('add');
    const saveBtn = document.getElementById('save');
    let friends = [];
    let helixToken = null;

    function render() {
      listEl.innerHTML = '';
      friends.forEach((f, i) => {
        const div = document.createElement('div');
        div.className = 'friend';
        div.innerHTML = `
          <img src="${f.profile_image_url}" alt="${f.display_name}">
          <span>${f.display_name} (${f.login})</span>
          <button data-index="${i}" style="background:#6441a5;">Remove</button>
        `;
        div.querySelector('button').onclick = () => {
          friends.splice(i, 1);
          render();
        };
        listEl.appendChild(div);
      });
    }

    addBtn.onclick = async () => {
      const login = document.getElementById('username').value.trim().toLowerCase();
      if (!login || !helixToken) return;
      try {
        const res = await fetch(`https://api.twitch.tv/helix/users?login=${login}`, {
          headers: { 'Client-ID': clientId, 'Authorization': `Bearer ${helixToken}` }
        });
        const data = await res.json();
        if (data.data && data.data[0]) {
          const user = data.data[0];
          if (!friends.find(f => f.id === user.id)) {
            friends.push({
              id: user.id,
              login: user.login,
              display_name: user.display_name,
              profile_image_url: user.profile_image_url
            });
            render();
          }
        }
      } catch (e) { console.error('Add friend error:', e); }
      document.getElementById('username').value = '';
    };

    saveBtn.onclick = () => {
      Twitch.ext.configuration.set('broadcaster', '1.0', JSON.stringify({ friends }));
      console.log('Config saved');
      alert('Saved!');
    };

    Twitch.ext.configuration.onChanged(() => {
      console.log('Config changed detected');
      if (Twitch.ext.configuration.broadcaster) {
        try {
          const cfg = JSON.parse(Twitch.ext.configuration.broadcaster.content);
          if (cfg.friends) friends = cfg.friends;
          render();
        } catch (e) { console.error('Parse error:', e); }
      }
    });

    Twitch.ext.onAuthorized((auth) => {
      helixToken = auth.helixToken;
      console.log('Authorized with token');
      // Initial load
      if (Twitch.ext.configuration.broadcaster) {
        try {
          const cfg = JSON.parse(Twitch.ext.configuration.broadcaster.content);
          if (cfg.friends) friends = cfg.friends;
          render();
        } catch (e) { console.error('Initial parse error:', e); }
      }
    });

    Twitch.ext.onError((e) => console.error('Twitch error:', e));
  </script>
</body>
</html>