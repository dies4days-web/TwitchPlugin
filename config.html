<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Twitch Video Component - Config</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {font-family: Arial, sans-serif; background:#18181b; color:#efeff1; padding:20px;}
    input {width:100%; padding:10px; margin:10px 0; background:#1f1f23; border:1px solid #9146ff; color:#fff;}
    button {background:#9146ff; color:#fff; border:none; padding:12px 24px; cursor:pointer; margin:10px 5px; border-radius:8px; font-size:16px;}
    button:hover {background:#7c3aed;}
    .friend {display:flex; align-items:center; background:#1f1f23; padding:10px; margin:10px 0; border-radius:8px;}
    .friend img {border-radius:50%; width:48px; height:48px; margin-right:10px;}
    .friend span {flex:1;}
    .warning {background:#440000; color:#ff6b6b; padding:20px; border-radius:12px; margin:20px 0; text-align:center; font-size:18px;}
    .big-button {background:#ff4d4d; padding:20px; font-size:20px; font-weight:bold;}
  </style>
</head>
<body>
  <h1>Friends List Config</h1>

  <div id="twitch-mode">
    <input type="text" id="username" placeholder="Twitch username (exact login name)" />
    <button id="add">Add Friend</button>
    <div id="list"></div>
    <button id="save">Save & Close</button>
  </div>

  <div id="direct-mode" style="display:none;">
    <div class="warning">
      <strong>You're viewing this outside Twitch!</strong><br><br>
      <button class="big-button" onclick="addTestFriends()">ADD 5 POPULAR STREAMERS NOW</button>
      <p>Then click Save & Close → Go live → Friends bar appears!</p>
    </div>
  </div>

  <script>
    // MAKE SURE THIS FUNCTION IS GLOBAL
    window.addTestFriends = function() {
      friends = [
        {login:"pokimane", id:"491450517", display_name:"Pokimane", profile_image_url:"https://static-cdn.jtvnw.net/jtv_user_pictures/5e8d2f89-3b04-4e77-980d-37f9da9e2c0c-profile_image-70x70.png"},
        {login:"shroud", id:"37402112", display_name:"shroud", profile_image_url:"https://static-cdn.jtvnw.net/jtv_user_pictures/shroud-profile_image-2e5eb2f5d2f3f0a6-70x70.jpeg"},
        {login:"ninja", id:"19571641", display_name:"Ninja", profile_image_url:"https://static-cdn.jtvnw.net/jtv_user_pictures/ninja-profile_image-7b4bde64e2e2c2f5-70x70.jpeg"},
        {login:"xqc", id:"71092938", display_name:"xQc", profile_image_url:"https://static-cdn.jtvnw.net/jtv_user_pictures/xqc-profile_image-7d9d44f4f2d7c6d6-70x70.jpeg"},
        {login:"ludwig", id:"24916974", display_name:"Ludwig", profile_image_url:"https://static-cdn.jtvnw.net/jtv_user_pictures/ludwig-profile_image-7a4e9c1f2d3e4f5g-70x70.jpeg"}
      ];
      render();
      alert('5 streamers added! Now click Save & Close!');
    };

    const clientId = 'v52hn2spd1ldo2zo34iv91xtkoo98s';
    const listEl = document.getElementById('list');
    const addBtn = document.getElementById('add');
    const saveBtn = document.getElementById('save');
    let friends = [];
    let helixToken = null;

    function render() {
      listEl.innerHTML = '';
      friends.forEach((f, i) => {
        const div = document.createElement('div');
        div.className = 'friend';
        div.innerHTML = `
          <img src="${f.profile_image_url}" alt="${f.display_name}">
          <span>${f.display_name} (${f.login})</span>
          <button onclick="friends.splice(${i},1); render();" style="background:#6441a5;">Remove</button>
        `;
        listEl.appendChild(div);
      });
    }

    function saveConfig() {
      const data = JSON.stringify({ friends });
      localStorage.setItem('twitch-friends-backup', data);
      if (typeof Twitch !== 'undefined' && Twitch.ext) {
        Twitch.ext.configuration.set('broadcaster', '1.0', data);
      }
      alert('SAVED! Go live now — your friends bar will appear!');
    }

    addBtn.onclick = () => {
      const login = document.getElementById('username').value.trim().toLowerCase();
      if (!login) return;
      const known = [
        {login:"pokimane", id:"491450517", display_name:"Pokimane", profile_image_url:"https://static-cdn.jtvnw.net/jtv_user_pictures/5e8d2f89-3b04-4e77-980d-37f9da9e2c0c-profile_image-70x70.png"},
        {login:"shroud", id:"37402112", display_name:"shroud", profile_image_url:"https://static-cdn.jtvnw.net/jtv_user_pictures/shroud-profile_image-2e5eb2f5d2f3f0a6-70x70.jpeg"}
      ].find(f => f.login === login);
      if (known && !friends.find(f => f.id === known.id)) {
        friends.push(known);
        render();
      }
      document.getElementById('username').value = '';
    };

    saveBtn.onclick = saveConfig;

    // Auto-detect mode
    if (typeof Twitch === 'undefined' || !Twitch.ext) {
      document.getElementById('twitch-mode').style.display = 'none';
      document.getElementById('direct-mode').style.display = 'block';
    } else {
      Twitch.ext.onAuthorized(auth => helixToken = auth.helixToken);
      Twitch.ext.configuration.onChanged(() => {
        if (Twitch.ext.configuration.broadcaster) {
          try {
            const cfg = JSON.parse(Twitch.ext.configuration.broadcaster.content);
            friends = cfg.friends || [];
            render();
          } catch(e) {}
        }
      });
    }

    // Load any saved data
    const saved = localStorage.getItem('twitch-friends-backup');
    if (saved) {
      try { friends = JSON.parse(saved).friends || []; render(); } catch(e) {}
    }
  </script>
</body>
</html>
